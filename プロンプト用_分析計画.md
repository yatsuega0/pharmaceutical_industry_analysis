# 製薬業界（13社・2024年度）財務データ：分析計画（プロンプト用）

## 0. 前提・目的・成果物

### 前提（データ仕様）
- 入力ファイル：`input/財務データ_製薬業界.xlsx`
- 対象：製薬業界該当企業 13社、2024年度決算（単年・クロスセクション）
- 主な列：
  - `証券コード`, `企業名`
  - `売上高`, `営業利益`, `当期純利益`
  - `総資産`, `自己資本`
  - `ROA`, `ROE`

### 目的（What）
1. **業界内でのポジショニング**（規模 × 収益性/効率）を可視化し、企業群の構造を把握する。  
2. **収益性の質**（本業収益力と最終利益の差）を把握し、異常値・特徴企業を特定する。  
3. **資本効率と財務体質**（ROA/ROE/自己資本比率/レバレッジ構造）を整理し、構造的な違いを説明する。  
4. **業界構造の類型化**（クラスタリング）により、製薬業界内のサブタイプを明確化する。  

### 成果物（Deliverables）
- `output/` に以下を生成
  - 集計テーブル（CSV/Excel）
  - 図表（PNG）
  - サマリー（Markdown）  
- `README.md` に再現手順、前提、生成物一覧を記載
- 解析は①〜④で独立した `.py` を作成しつつ、共通処理は `modules/` に切り出して再利用する。

---

## 1. プロジェクト構成（指定）

```
project_root/
  input/
    財務データ_製薬業界.xlsx # ユーザーが準備
  output/
    (生成物を保存)
  src/
    01_positioning.py
    02_profitability_decompose.py
    03_capital_efficiency.py
    04_clustering.py
  modules/
    io.py
    preprocess.py
    metrics.py
    viz.py
    report.py
  main.py                    # エントリーポイント（全分析の一括実行）
  pyproject.toml
  README.md
  プロンプト用_分析計画.md   # ←本ファイル
```

### ルール（推奨）
- プロジェクトディレクトリとinput以外は作成する（必須）
- スクリプト：`src/01_*.py` のように番号で順序を明確化
- 出力ファイル：`output/01_...`, `output/fig_01_...` のように対応関係がわかる名前
- 可視化の際は日本語フォント出力用に`import japanize_matplotlib`を必ずimportに入れること
- `src`のスクリプトはすべて以下記載例のように記載すること（厳守）
```python
# %%[markdown]
# ### データの読み込み（目的や仮説、実行内容を記載）
# %%
スクリプト（あるいは関数）
# %%
# %%[markdown]
# ### xxxの分析
# - 目的:xxx
# %%
```

### 環境構築
- 環境構築はpoetryで行う
- jupyterカーネルなどの設定はユーザが行う
- `pyproject.toml`の中身は以下（プロジェクト名は適宜記載すること）
```
[tool.poetry]

[tool.poetry.dependencies]
python = "^3.12"
jupyterlab = "*"
pandas = "*"
numpy = "*"
matplotlib = "*"
seaborn = "*"
scipy = "*"
jupyterlab-code-formatter = "*"
jupyterlab-execute-time = "*"
black = "*"
isort = "*"
japanize-matplotlib = "*"
pyarrow = "*"
scikit-learn = "*"
sweetviz = "*"
plotly = "*"
lightgbm = "*"
stl = "*"
numpy-stl = "*"
catboost = "*"
optuna = "*"
xgboost = "*"
openpyxl = "*"
tabulate = "*"
adjusttext = "*"
statsmodels = "*"
pytest = "*"
tabulate = "*"

[tool.poetry.group.dev.dependencies]
notebook = "^7.5.0"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"
```
- `pyproject.toml`を作成後に`poetry install`をコマンドで実行して環境を作成

---

## 2. 共通モジュール設計（modules/）

> ①〜④の各スクリプトで重複しがちな処理を共通化し、可読性・再現性・保守性を上げる。

### `modules/io.py`
- `load_financial_xlsx(path: str) -> pd.DataFrame`
  - Excel読込、列名の正規化（全角/半角、空白除去など）
- `save_table(df, path, index=False)`
- `ensure_output_dir(path)`

### `modules/preprocess.py`
- `coerce_numeric(df, cols)`：数値列の型変換（カンマ除去等）
- `validate_columns(df, required_cols)`：必須列チェック
- `handle_missing(df, strategy)`：欠損の扱い（除外/補完/警告）

### `modules/metrics.py`
- 追加指標の計算（列追加）
  - `営業利益率 = 営業利益 / 売上高`
  - `当期純利益率 = 当期純利益 / 売上高`
  - `自己資本比率 = 自己資本 / 総資産`
  - `総資産回転率 = 売上高 / 総資産`
  - `ROE_ROA_gap = ROE - ROA`
- 外れ値判定（IQR / z-score）補助関数

### `modules/viz.py`
- 散布図/バブル図/分布図の共通描画関数（matplotlib）
- 画像保存（dpi、余白、フォント、ラベル）統一
- `annotate_points`：企業名注釈（必要時）

### `modules/report.py`
- 集計サマリー（平均/中央値/四分位/最小/最大）生成
- Markdownの簡易出力（表＋要点）
- **観察事項の出力機能**（重要）:
  - `save_summary(observations: str, output_path: str)`: 分析者が記載した観察事項をMarkdown形式で保存
  - 基本統計量とグラフへの参照を自動で含める
  - 分析者が記載した考察・発見事項をそのまま出力

---

## 2-1. 観察事項・考察の記載方法（重要な設計指針）

### 基本方針
各分析スクリプト（`src/01_*.py` 〜 `src/04_*.py`）は、**分析者自身が結果を確認した上で観察事項や考察をまとめる**設計とする。これにより、単なるデータ出力ではなく、洞察を含んだ分析レポートとなる。

### 実装方法

#### 1. 各スクリプトの最終セクション
各スクリプトの最後に、以下のセクションを必ず配置する：

```python
# %%[markdown]
# ### 観察事項・考察
# 
# 分析者がここに結果を確認した上で観察事項を記載する：
# - 発見された特徴（外れ値、上位/下位企業、象限別の傾向など）
# - データから読み取れる考察
# - 仮説の検証結果
# - 追加で分析すべき項目

# %%
# 観察事項の記載（分析者が編集する部分）
observations = """
## 観察事項

### 主要な発見
- （ここに具体的な発見を記載）
- 例: 企業Aは総資産が最大だが、ROAは業界平均（5.2%）を下回る3.8%
- 例: 企業B、Cは中堅規模（総資産1-2兆円）ながらROA 7%超を実現

### 外れ値の分析
- （外れ値企業とその理由の考察）

### 象限別の特徴
- 高規模・高効率: 企業D、E（大手で高収益性を維持）
- 高規模・低効率: 企業A（規模の割に効率が低い）
- 中規模・高効率: 企業B、C（資産効率が高い）

### 考察
- （データから読み取れる示唆）
- 例: 規模と効率性は必ずしも比例せず、中堅企業の資産効率の高さは研究開発の効率性を示唆

### 次のステップ
- （さらに深掘りすべきポイント）
"""

# 観察事項をファイルに保存
report.save_summary(
    observations=observations,
    output_path=project_root / "output" / "01_summary.md",
    stats=df.describe(),  # 基本統計量も含める
    metadata={
        "分析名": "ポジショニング分析",
        "対象企業数": len(df),
        "分析日": pd.Timestamp.now().strftime("%Y-%m-%d")
    }
)

print("\n観察事項を output/01_summary.md に保存しました")
```

#### 2. modules/report.pyの実装要件

`save_summary()` 関数を以下の仕様で実装する：

```python
def save_summary(
    observations: str,
    output_path: Union[str, Path],
    stats: Optional[pd.DataFrame] = None,
    metadata: Optional[Dict[str, Any]] = None
) -> None:
    """
    分析者が記載した観察事項をMarkdownファイルとして保存
    
    Parameters
    ----------
    observations : str
        分析者が記載した観察事項・考察（Markdown形式）
    output_path : Union[str, Path]
        出力先ファイルパス（.md）
    stats : Optional[pd.DataFrame], default=None
        基本統計量（含める場合）
    metadata : Optional[Dict[str, Any]], default=None
        メタデータ（分析名、日時など）
    """
    # メタデータの出力
    # 基本統計量の出力（オプション）
    # 観察事項の出力
    # グラフファイルへのリンク自動生成
```

#### 3. 各分析での記載内容の例

##### 分析①：ポジショニング分析
- 規模と効率性の関係（比例するか、乖離があるか）
- 外れ値企業の特定とその理由の推測
- 象限別の企業分類（大手安定型、高効率中堅型など）

##### 分析②：収益性分解
- 営業利益率と純利益率の乖離が大きい企業の特定
- 乖離の理由（特別損失、金融費用、税負担など）の考察
- 利益の「質」が高い企業群の特徴

##### 分析③：資本効率・財務体質
- ROAとROEの関係（レバレッジ効果の有無）
- 自己資本比率と収益性の関係
- 高ROE・低自己資本比率企業のリスク評価

##### 分析④：クラスタリング
- 各クラスターの特徴（ビジネスモデルの違い）
- クラスター間の系統的な差異
- 業界構造の類型化（大手安定型、高効率型、レバレッジ型など）

### 注意事項
- 観察事項は**必ず分析者が記載する**（自動生成しない）
- 具体的な企業名と数値を含めることで説得力を持たせる
- 仮説（H1-1, H1-2など）の検証結果を明記する
- 追加分析の提案を含めることで、さらなる深掘りの方向性を示す

---

## 3. 分析①：ポジショニング（規模 × 効率）

### 目的
- 13社を「規模（売上・資産）」と「収益性/効率（ROA/ROE/利益率）」で配置し、業界内の立ち位置を可視化する。

### 仮説（例）
- **H1-1**：規模（売上高・総資産）が大きい企業が必ずしも高ROA/高ROEではない。  
- **H1-2**：中堅規模でもROAが高い企業群が存在し、資産効率/研究効率の差が示唆される。

### 実施内容
- 作成する指標：`営業利益率`, `当期純利益率`, `自己資本比率`, `総資産回転率`（modules/metrics.py）
- 図表（推奨）
  1. **散布図**：x=総資産（log可） / y=ROA（%）
  2. **散布図**：x=売上高（log可） / y=ROE（%）
  3. **バブル図**：x=売上高 / y=ROA / bubble=総資産（または逆）
- 補助：外れ値企業（IQR上位/下位）にラベル付け

### 期待されるアウトプット
- `output/01_positioning_table.csv`：主要指標＋追加指標
- `output/fig_01_roa_vs_assets.png`
- `output/fig_01_roe_vs_sales.png`
- `output/01_summary.md`：**分析者が記載した観察事項・考察を含む**
  - 上位/下位企業の特定
  - 外れ値の分析
  - 象限別の企業分類
  - 規模と効率性の関係についての考察
  - 仮説（H1-1, H1-2）の検証結果

### 実装（ファイル）
- `src/01_positioning.py`：読込→前処理→指標追加→図表作成→**観察事項記載セクション**→サマリー出力
  - **重要**: 最後のセルで分析者が観察事項を記載し、`report.save_summary()`で出力する設計とする

---

## 4. 分析②：収益性分解（マージン分析）

### 目的
- 本業（営業利益）と最終利益（純利益）の差を比較し、利益の「質」を把握する。

### 仮説（例）
- **H2-1**：営業利益率が高いが当期純利益率が低い企業は、特別損益・金融費用・税負担などの影響が相対的に大きい。  
- **H2-2**：営業利益率と当期純利益率が近い企業ほど、利益構造が安定的で説明しやすい。

### 実施内容
- 作成指標
  - `営業利益率`, `当期純利益率`
  - `利益率差分 = 営業利益率 - 当期純利益率`
  - （可能なら）`当期純利益/営業利益`（営業利益が0付近の場合は注意）
- 図表（推奨）
  1. **棒グラフ**：営業利益率・当期純利益率（企業別、並べ替え）
  2. **散布図**：x=営業利益率 / y=当期純利益率（45度線で乖離確認）
  3. **乖離ランキング**：利益率差分の上位/下位

### 期待されるアウトプット
- `output/02_margin_table.csv`
- `output/fig_02_margins_by_company.png`
- `output/fig_02_opm_vs_npm.png`
- `output/02_summary.md`：**分析者が記載した観察事項・考察を含む**
  - 乖離が大きい企業の特定と解釈
  - 営業利益率と当期純利益率の関係についての考察
  - 仮説（H2-1, H2-2）の検証結果

### 実装（ファイル）
- `src/02_profitability_decompose.py`：読込→前処理→指標追加→図表作成→**観察事項記載セクション**→サマリー出力

---

## 5. 分析③：資本効率・財務体質（ROA/ROE/自己資本比率）

### 目的
- ROAとROEの関係、および自己資本比率から、資本構造の違い（レバレッジ構造）を把握する。

### 仮説（例）
- **H3-1**：ROEが高いがROAが相対的に低い企業は、自己資本比率が低めでレバレッジによりROEが押し上げられている。  
- **H3-2**：ROAとROEが両方高い企業は、収益性と資産効率が両立しており「質の高い高効率」とみなせる。

### 実施内容
- 作成指標
  - `自己資本比率 = 自己資本 / 総資産`
  - `ROE_ROA_gap = ROE - ROA`
  - `総資産回転率 = 売上高 / 総資産`（ROA分解の補助）
- 図表（推奨）
  1. **散布図**：x=ROA / y=ROE（企業名ラベル必要なら付与）
  2. **散布図**：x=自己資本比率 / y=ROE（財務体質×株主収益）
  3. **散布図**：x=自己資本比率 / y=ROE_ROA_gap（レバレッジ効果の可視化）
  4. **ROA分解的な補助図**：資産回転率 vs 利益率（純利益率 or 営業利益率）

### 期待されるアウトプット
- `output/03_capital_table.csv`
- `output/fig_03_roa_vs_roe.png`
- `output/fig_03_equity_ratio_vs_roe.png`
- `output/03_summary.md`：**分析者が記載した観察事項・考察を含む**
  - 象限別整理（高ROA高ROE、高ROE低ROA等）
  - レバレッジ効果の分析
  - 資本構造と収益性の関係についての考察
  - 仮説（H3-1, H3-2）の検証結果

### 実装（ファイル）
- `src/03_capital_efficiency.py`：読込→前処理→指標追加→図表作成→**観察事項記載セクション**→サマリー出力

---

## 6. 分析④：クラスタリング（業界構造の類型化）

### 目的
- 13社を複数の型（ビジネス/財務特性）に分類し、業界構造を説明可能にする。

### 仮説（例）
- **H4-1**：製薬業界内に「大手安定（規模大・効率中）」「高効率中堅（効率高）」「高ROEレバレッジ型（ROE高・自己資本比率低）」のような複数クラスターが存在する。  
- **H4-2**：クラスター間で、利益率・資産回転・自己資本比率の組合せが系統的に異なる。

### 実施内容（推奨フロー）
1. 変数セットを定義（例）
   - 規模：`売上高`（log変換推奨） or `総資産`（log変換推奨）
   - 収益性：`営業利益率`, `当期純利益率`
   - 効率：`ROA`, `ROE`
   - 体質：`自己資本比率`
2. 前処理
   - 標準化（z-score）
   - 欠損がある場合：クラスター対象外 or 補完（原則は除外＋警告）
3. 手法
   - k-means（k=2〜4を試し、Silhouette/解釈容易性で選定）
   - 併せて階層クラスタ（Ward法）で妥当性チェック（任意）
4. 可視化
   - PCAで2次元に落として散布図（クラスター色分け）
   - クラスター別平均プロファイル（レーダー/棒）

### 期待されるアウトプット
- `output/04_cluster_assignments.csv`：企業→クラスター付与
- `output/fig_04_pca_clusters.png`
- `output/fig_04_cluster_profile.png`
- `output/04_summary.md`：**分析者が記載した観察事項・考察を含む**
  - 各クラスターの特徴（特徴量の平均差、代表企業）
  - クラスター間の系統的な差異の分析
  - 業界構造の類型化（大手安定型、高効率中堅型、レバレッジ型など）
  - 仮説（H4-1, H4-2）の検証結果

### 実装（ファイル）
- `src/04_clustering.py`：読込→前処理→クラスタリング→PCA可視化→**観察事項記載セクション**→サマリー出力

---

## 7. 共通：品質チェック（全分析共通で必須）

### データ品質チェック項目
- 数値列の型変換（文字列/カンマ/欠損）
- 分母が0に近い指標（利益率、回転率）での異常値
- ROA/ROE列が「%」なのか「比率（0.05）」なのかの判定
  - 例：最大値が 1 を超えるなら「%」の可能性、など  
  - 必要なら一括変換して揃える

### 出力の再現性
- すべての出力に、元データの行数、欠損処理方針、使用列、作成指標を明記（サマリーmdに記載）

---

## 8. 実行の想定（README向け）

### コマンドライン実行

`main.py`をエントリーポイントとして全分析を順番に実行する。個別スクリプトのコマンド実行は想定しない。

```bash
# 全分析を順番に実行
python main.py

# エラー時に停止するモード
python main.py --stop-on-error

# 特定の分析のみ実行
python main.py --script 1  # ポジショニング分析のみ
python main.py --script 2  # 収益性分解のみ
python main.py --script 3  # 資本効率分析のみ
python main.py --script 4  # クラスタリング分析のみ
```

### Interactive Window実行

VS CodeのInteractive Windowで段階的に実行する想定。

#### 方法1：main.pyでの実行
- `main.py`は `# %%` セルマーカーを使用
- 実行手順：
  1. 全セルを実行して関数を定義
  2. ファイル最後の実行用セルのコメントを外して実行
  3. `run_all_analyses()` または `run_single_analysis(N)` を呼び出す

#### 方法2：個別スクリプトでの実行
- 各分析を詳細確認しながら実行する場合
- `src/0X_*.py` を開いてセル単位で実行
- 各セルの結果を確認しながら進める
- 最後のセルで観察事項を記載して出力

### main.pyの機能
- `run_script()`: 個別スクリプトの実行（セルマーカー除去処理込み）
- `run_all_analyses()`: 全分析を順番に実行（エラーハンドリング付き）
- `run_single_analysis(N)`: 指定番号の分析のみ実行
- `main()`: コマンドライン引数の解析とルーティング
- 実行時間の計測と結果サマリーの表示

---

## 9. 追加の任意分析（必要なら後で拡張）
- 業界平均との差分（平均との差：ΔROA, ΔROE, Δ利益率）
- 外れ値の説明テンプレ（なぜ外れたかの仮説を列挙）
- 他業界（例：AI/SaaS）との比較章の雛形（分布比較・箱ひげ）

